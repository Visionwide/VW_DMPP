@page "/yysc"
@using VW_DMPP.Data
@using VW_DMPP.Services
@inject YyscService YyscService
@inject IJSRuntime JSRuntime

<PageTitle>機台紀錄列表</PageTitle>

<div class="container">
    <h3>機台紀錄列表</h3>
    @* <script src="js/colResizable-1.6.min.js"></script> 移除，因為不再需要欄位寬度調整 *@

    <div class="mb-3 d-flex align-items-center justify-content-between">
        <div class="button-bar">
            <button class="btn btn-primary" @onclick="LoadData">
                <i class="bi bi-arrow-clockwise"></i> 載入資料
            </button>
            <button class="btn btn-success" @onclick="AddNew">
                <i class="bi bi-plus-circle"></i> 新增資料
            </button>
            @* 🌟 新增：儲存資料按鈕 (在原程式碼中只有 SaveEdit，但沒有單獨的 SaveData 按鈕) *@
            <button class="btn btn-info text-white" @onclick="SaveData">
                <i class="bi bi-floppy"></i> 輸出Excel
            </button>
        </div>

        <div class="input-group search-bar">
            <span class="input-group-text"><i class="bi bi-search"></i> 查詢</span>
            <input type="text" class="form-control" placeholder="輸入 機號 或 機型 進行查詢..."
                   @bind="searchTerm"
                   @bind:event="oninput"
                   @onkeyup="FilterData" />
        </div>
    </div>

    @if (errorMessage != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>錯誤:</strong> @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }

    @if (successMessage != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <strong>成功:</strong> @successMessage
            <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
        </div>
    }

    @if (isEditing)
    {
        <div class="card mb-4 shadow-sm edit-card">
            <div class="card-header bg-warning text-dark">
                <h5>@(isNewItem ? "新增" : $"編輯 機號: {editingItem.機號}")資料 (26 欄位)</h5>
            </div>
            <div class="card-body">

                <div class="row">
                    <div class="col-md-4 mb-3"><label class="form-label">出機日期</label><input type="date" class="form-control" @bind="editingItem.出機日期" /></div>
                    <div class="col-md-4 mb-3"><label class="form-label">機號</label><input type="text" class="form-control" @bind="editingItem.機號" /></div>
                    <div class="col-md-4 mb-3"><label class="form-label">機型</label><input type="text" class="form-control" @bind="editingItem.機型" /></div>
                </div>

                <div class="row">
                    <h6 class="mt-3 text-primary">尺/雷射/循圓量測</h6>
                    <div class="col-md-3 mb-3"><label class="form-label">光學尺_X軸</label><input type="number" step="0.001" class="form-control" @bind="editingItem.光學尺_X軸" /></div>
                    <div class="col-md-3 mb-3"><label class="form-label">光學尺_Y軸</label><input type="number" step="0.001" class="form-control" @bind="editingItem.光學尺_Y軸" /></div>
                    <div class="col-md-3 mb-3"><label class="form-label">光學尺_Z軸</label><input type="number" step="0.001" class="form-control" @bind="editingItem.光學尺_Z軸" /></div>
                    <div class="col-md-3 mb-3"><label class="form-label">雷射_X軸_P</label><input type="number" step="0.001" class="form-control" @bind="editingItem.雷射_X軸_P" /></div>
                    <div class="col-md-3 mb-3"><label class="form-label">雷射_X軸_PS</label><input type="number" step="0.001" class="form-control" @bind="editingItem.雷射_X軸_PS" /></div>
                    <div class="col-md-3 mb-3"><label class="form-label">雷射_Y軸_P</label><input type="number" step="0.001" class="form-control" @bind="editingItem.雷射_Y軸_P" /></div>
                    <div class="col-md-3 mb-3"><label class="form-label">雷射_Y軸_PS</label><input type="number" step="0.001" class="form-control" @bind="editingItem.雷射_Y軸_PS" /></div>
                    <div class="col-md-3 mb-3"><label class="form-label">雷射_Z軸_P</label><input type="number" step="0.001" class="form-control" @bind="editingItem.雷射_Z軸_P" /></div>
                    <div class="col-md-3 mb-3"><label class="form-label">雷射_Z軸_PS</label><input type="number" step="0.001" class="form-control" @bind="editingItem.雷射_Z軸_PS" /></div>
                    <div class="col-md-3 mb-3"><label class="form-label">循圓_XY軸</label><input type="number" step="0.001" class="form-control" @bind="editingItem.循圓_XY軸" /></div>

                    <h6 class="mt-3 text-primary">幾何量測</h6>
                    <div class="col-md-3 mb-3"><label class="form-label">工作台面平行度_X軸</label><input type="number" step="0.001" class="form-control" @bind="editingItem.幾何_工作台面平行度_X軸" /></div>
                    <div class="col-md-3 mb-3"><label class="form-label">工作台面平行度_Y軸</label><input type="number" step="0.001" class="form-control" @bind="editingItem.幾何_工作台面平行度_Y軸" /></div>
                    <div class="col-md-3 mb-3"><label class="form-label">T型槽平行度_X軸方向</label><input type="number" step="0.001" class="form-control" @bind="editingItem.幾何_T型槽平行度_X軸方向" /></div>
                    <div class="col-md-3 mb-3"><label class="form-label">直角度_XY軸</label><input type="number" step="0.001" class="form-control" @bind="editingItem.幾何_直角度_XY軸" /></div>
                    <div class="col-md-3 mb-3"><label class="form-label">直角度_ZX軸</label><input type="number" step="0.001" class="form-control" @bind="editingItem.幾何_直角度_ZX軸" /></div>
                    <div class="col-md-3 mb-3"><label class="form-label">直角度_ZY軸</label><input type="number" step="0.001" class="form-control" @bind="editingItem.幾何_直角度_ZY軸" /></div>
                    <div class="col-md-3 mb-3"><label class="form-label">主軸直角度_X軸方向</label><input type="number" step="0.001" class="form-control" @bind="editingItem.幾何_主軸直角度_X軸方向" /></div>
                    <div class="col-md-3 mb-3"><label class="form-label">主軸直角度_Y軸方向</label><input type="number" step="0.001" class="form-control" @bind="editingItem.幾何_主軸直角度_Y軸方向" /></div>

                    <h6 class="mt-3 text-primary">主軸量測</h6>
                    <div class="col-md-3 mb-3"><label class="form-label">主軸_外圓偏擺</label><input type="number" step="0.001" class="form-control" @bind="editingItem.主軸_外圓偏擺" /></div>
                    <div class="col-md-3 mb-3"><label class="form-label">主軸_端面偏擺_上端</label><input type="number" step="0.001" class="form-control" @bind="editingItem.主軸_端面偏擺_上端" /></div>
                    <div class="col-md-3 mb-3"><label class="form-label">主軸_端面偏擺_下端</label><input type="number" step="0.001" class="form-control" @bind="editingItem.主軸_端面偏擺_下端" /></div>
                    <div class="col-md-3 mb-3"><label class="form-label">主軸_錐孔偏擺_300mm</label><input type="number" step="0.001" class="form-control" @bind="editingItem.主軸_錐孔偏擺_300mm" /></div>
                </div>

                <div class="mt-4">
                    <button class="btn btn-success me-2" @onclick="SaveEdit"><i class="bi bi-check-circle"></i> 儲存變更</button>
                    <button class="btn btn-secondary" @onclick="CancelEdit"><i class="bi bi-x-circle"></i> 取消</button>
                </div>
            </div>
        </div>
    }

    <h4>📋 資料列表 (共 @filteredDataList.Count 筆 / 總共 @dataList.Count 筆)</h4>

    @* 🌟 移除 fixed-table-wrapper 等容器，直接顯示單一表格 *@
    <div class="table-responsive-scroll"> @* 使用一個新的 class 來控制滾動 *@
        <table class="table table-striped table-hover table-bordered align-middle full-width-table">
            <thead>
                <tr class="table-dark">
                    <th>出機日期</th>
                    <th>機號</th>
                    <th>機型</th>
                    <th>光學尺_X軸</th>
                    <th>光學尺_Y軸</th>
                    <th>光學尺_Z軸</th>
                    <th>雷射_X軸_P</th>
                    <th>雷射_X軸_PS</th>
                    <th>雷射_Y軸_P</th>
                    <th>雷射_Y軸_PS</th>
                    <th>雷射_Z軸_P</th>
                    <th>雷射_Z軸_PS</th>
                    <th>循圓_XY軸</th>
                    <th>幾何_工作台面平行度_X軸</th>
                    <th>幾何_工作台面平行度_Y軸</th>
                    <th>幾何_T型槽平行度_X軸方向</th>
                    <th>幾何_直角度_XY軸</th>
                    <th>幾何_直角度_ZX軸</th>
                    <th>幾何_直角度_ZY軸</th>
                    <th>幾何_主軸直角度_X軸方向</th>
                    <th>幾何_主軸直角度_Y軸方向</th>
                    <th>主軸_外圓偏擺</th>
                    <th>主軸_端面偏擺_上端</th>
                    <th>主軸_端面偏擺_下端</th>
                    <th>主軸_錐孔偏擺_300mm</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in filteredDataList)
                {
                    <tr class="@(item.機號 == currentEditingOriginalItem?.機號 ? "table-warning" : "")">
                        <td>@item.出機日期.ToString("yyyy-MM-dd")</td>
                        <td><strong>@item.機號</strong></td>
                        <td>@item.機型</td>
                        @* 🌟 將「光學尺_X軸」等判斷邏輯移到主表格中 *@
                        <td>@(item.光學尺_X軸.HasValue && item.光學尺_X軸 != 0 ? "Y" : "N")</td>
                        <td>@(item.光學尺_Y軸.HasValue && item.光學尺_Y軸 != 0 ? "Y" : "N")</td>
                        <td>@(item.光學尺_Z軸.HasValue && item.光學尺_Z軸 != 0 ? "Y" : "N")</td>
                        <td>@item.雷射_X軸_P</td>
                        <td>@item.雷射_X軸_PS</td>
                        <td>@item.雷射_Y軸_P</td>
                        <td>@item.雷射_Y軸_PS</td>
                        <td>@item.雷射_Z軸_P</td>
                        <td>@item.雷射_Z軸_PS</td>
                        <td>@item.循圓_XY軸</td>
                        <td>@item.幾何_工作台面平行度_X軸</td>
                        <td>@item.幾何_工作台面平行度_Y軸</td>
                        <td>@item.幾何_T型槽平行度_X軸方向</td>
                        <td>@item.幾何_直角度_XY軸</td>
                        <td>@item.幾何_直角度_ZX軸</td>
                        <td>@item.幾何_直角度_ZY軸</td>
                        <td>@item.幾何_主軸直角度_X軸方向</td>
                        <td>@item.幾何_主軸直角度_Y軸方向</td>
                        <td>@item.主軸_外圓偏擺</td>
                        <td>@item.主軸_端面偏擺_上端</td>
                        <td>@item.主軸_端面偏擺_下端</td>
                        <td>@item.主軸_錐孔偏擺_300mm</td>
                        @* 🌟 修正：上一個表格中重複了 `主軸_端面偏擺_下端`，這裡修正為 `主軸_錐孔偏擺_300mm`。並統一移到這裡 *@
                        @* <td>@item.主軸_錐孔偏擺_300mm</td> *@

                        <td>
                            <button class="btn btn-sm btn-primary me-2" @onclick="() => EditItem(item)">
                                <i class="bi bi-pencil"></i> 編輯
                            </button>
                            <button class="btn btn-sm btn-danger" @onclick="() => DeleteItem(item)">
                                <i class="bi bi-trash"></i> 刪除
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @if (filteredDataList.Count == 0 && dataList.Count > 0)
    {
        <div class="alert alert-warning">
            找不到符合 **"@searchTerm"** 的資料。
        </div>
    }
    @if (dataList.Count == 0)
    {
        <div class="alert alert-info">
            尚無資料，請點選「載入資料」或「新增資料」
        </div>
    }
</div>


<style>
    .search-bar {
        max-width: 400px;
        margin-left: 1rem;
    }

    .edit-card {
        border-left: 5px solid #ffc107;
    }

    .form-control {
        font-size: 0.85rem;
    }

    /* 🌟 新增樣式：讓表格在寬度不足時能水平滾動，並限制高度以供垂直滾動 */
    .table-responsive-scroll {
        /* 控制表格的垂直滾動 */
        max-height: 70vh; 
        overflow-y: auto;
        /* 控制表格的水平滾動 */
        overflow-x: auto;
        border: 1px solid #dee2e6;
    }

    /* 讓表格單行內容不換行，確保寬度超過容器時觸發水平滾動 */
    .full-width-table {
        margin-bottom: 0;
        border-collapse: collapse;
        font-size: 0.8rem;
        white-space: nowrap; 
    }

    /* 確保表頭固定 (在垂直滾動時) */
    .full-width-table thead th {
        position: sticky;
        top: 0;
        z-index: 10; /* 確保表頭在上方 */
        background-color: #343a40;
        color: white;
    }
</style>

@code {
    private List<YyscData> dataList = new();
    private List<YyscData> filteredDataList = new();

    // 🌟 用於編輯/新增的資料物件
    private YyscData editingItem = new();
    // 🌟 用於儲存「原始」被編輯的物件，以便在 SaveEdit 時找到它並替換
    private YyscData? currentEditingOriginalItem = null;

    private bool isEditing = false;
    // 🌟 輔助判斷是「新增」還是「編輯」
    private bool isNewItem => currentEditingOriginalItem == null;

    private string? errorMessage;
    private string? successMessage;
    private string searchTerm = string.Empty;

    protected override void OnInitialized()
    {
        try
        {
            LoadData();
        }
        catch (Exception ex)
        {
            errorMessage = $"初始化失敗: {ex.Message}";
        }
    }

    private void LoadData()
    {
        try
        {
            dataList = YyscService.ReadData();
            FilterData();
            successMessage = $"成功載入 {dataList.Count} 筆資料";
            errorMessage = null;
        }
        catch (Exception ex)
        {
            errorMessage = $"載入資料失敗: {ex.Message}";
        }
    }

    private void FilterData()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            filteredDataList = dataList;
        }
        else
        {
            var term = searchTerm.Trim().ToLowerInvariant();
            filteredDataList = dataList
                .Where(item =>
                    (item.機號 != null && item.機號.ToLowerInvariant().Contains(term)) ||
                    (item.機型 != null && item.機型.ToLowerInvariant().Contains(term)))
                .ToList();
        }
    }

    private void SaveData()
    {
        try
        {
            YyscService.SaveData(dataList);
            successMessage = "資料已成功儲存至 Excel";
            errorMessage = null;
        }
        catch (Exception ex)
        {
            errorMessage = $"儲存資料失敗: {ex.Message}";
        }
    }

    // 🌟 修正: 初始化所有欄位為預設值
    private void AddNew()
    {
        if (isEditing) CancelEdit(); // 如果正在編輯，先取消

        editingItem = new YyscData
        {
            出機日期 = DateTime.Now,
            機號 = $"TEMP-{DateTime.Now.Ticks.ToString().Substring(10)}", // 臨時機號
            機型 = string.Empty,

            // 確保所有數值欄位都初始化為 0
            光學尺_X軸 = 0, 光學尺_Y軸 = 0, 光學尺_Z軸 = 0,
            雷射_X軸_P = 0, 雷射_X軸_PS = 0, 雷射_Y軸_P = 0, 雷射_Y軸_PS = 0,
            雷射_Z軸_P = 0, 雷射_Z軸_PS = 0, 循圓_XY軸 = 0,

            幾何_工作台面平行度_X軸 = 0, 幾何_工作台面平行度_Y軸 = 0, 幾何_T型槽平行度_X軸方向 = 0,
            幾何_直角度_XY軸 = 0, 幾何_直角度_ZX軸 = 0, 幾何_直角度_ZY軸 = 0,
            幾何_主軸直角度_X軸方向 = 0, 幾何_主軸直角度_Y軸方向 = 0,

            主軸_外圓偏擺 = 0, 主軸_端面偏擺_上端 = 0, 主軸_端面偏擺_下端 = 0,
            主軸_錐孔偏擺_300mm = 0
        };
        currentEditingOriginalItem = null; // 標記為新增
        isEditing = true;
    }

    // 🌟 修正: 確保複製所有欄位 (深層複製)
    private void EditItem(YyscData item)
    {
        if (isEditing) CancelEdit(); // 如果正在編輯，先取消

        currentEditingOriginalItem = item; // 儲存原始物件
        editingItem = CopyYyscData(item);  // 編輯副本
        isEditing = true;
    }

    private void SaveEdit()
    {
        // 1. 檢查機號是否重複（排除正在編輯的原始機號）
        if (string.IsNullOrWhiteSpace(editingItem.機號) || dataList.Any(x => x.機號 == editingItem.機號 && x != currentEditingOriginalItem))
        {
            errorMessage = "儲存失敗: 機號不可為空，且不能與其他現有資料重複。";
            return;
        }

        if (currentEditingOriginalItem == null)
        {
            // 這是新增操作
            dataList.Add(editingItem);
            successMessage = "新資料已新增（記得點選「儲存至 Excel」）";
        }
        else
        {
            // 這是編輯操作 - 找到原始物件並替換
            var index = dataList.IndexOf(currentEditingOriginalItem);
            if (index != -1)
            {
                dataList[index] = editingItem;
            }
            successMessage = "資料已更新（記得點選「儲存至 Excel」）";
        }

        CancelEdit();
    }

    private void CancelEdit()
    {
        currentEditingOriginalItem = null;
        isEditing = false;
        editingItem = new();
        errorMessage = null;
        FilterData();
    }

    private async Task DeleteItem(YyscData item)
    {
        if (isEditing) CancelEdit(); // 刪除前確保退出編輯模式
        
        // 🌟 建議在刪除前增加確認視窗
        bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"確定要刪除 機號: {item.機號} 的紀錄嗎？");

        if (confirmed)
        {
            if (dataList.Remove(item))
            {
                FilterData();
                successMessage = $"機號 {item.機號} 的資料已刪除";
            }
        }
    }

    // 🌟 輔助方法：深層複製 YyscData 物件 (確保所有 26 個欄位都複製)
    private YyscData CopyYyscData(YyscData source)
    {
        return new YyscData
        {
            出機日期 = source.出機日期, 機號 = source.機號, 機型 = source.機型,
            光學尺_X軸 = source.光學尺_X軸, 光學尺_Y軸 = source.光學尺_Y軸, 光學尺_Z軸 = source.光學尺_Z軸,
            雷射_X軸_P = source.雷射_X軸_P, 雷射_X軸_PS = source.雷射_X軸_PS, 雷射_Y軸_P = source.雷射_Y軸_P,
            雷射_Y軸_PS = source.雷射_Y軸_PS, 雷射_Z軸_P = source.雷射_Z軸_P, 雷射_Z軸_PS = source.雷射_Z軸_PS,
            循圓_XY軸 = source.循圓_XY軸,
            幾何_工作台面平行度_X軸 = source.幾何_工作台面平行度_X軸, 幾何_工作台面平行度_Y軸 = source.幾何_工作台面平行度_Y軸,
            幾何_T型槽平行度_X軸方向 = source.幾何_T型槽平行度_X軸方向, 幾何_直角度_XY軸 = source.幾何_直角度_XY軸,
            幾何_直角度_ZX軸 = source.幾何_直角度_ZX軸, 幾何_直角度_ZY軸 = source.幾何_直角度_ZY軸,
            幾何_主軸直角度_X軸方向 = source.幾何_主軸直角度_X軸方向, 幾何_主軸直角度_Y軸方向 = source.幾何_主軸直角度_Y軸方向,
            主軸_外圓偏擺 = source.主軸_外圓偏擺, 主軸_端面偏擺_上端 = source.主軸_端面偏擺_上端,
            主軸_端面偏擺_下端 = source.主軸_端面偏擺_下端, 主軸_錐孔偏擺_300mm = source.主軸_錐孔偏擺_300mm
        };
    }
}